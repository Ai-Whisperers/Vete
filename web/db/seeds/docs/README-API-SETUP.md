# API-Based Environment Setup

This directory contains a new API-based approach to setting up your veterinary platform environment. Instead of generating SQL and inserting data directly into the database, this approach uses your API endpoints to create data the way real users would.

## ðŸŽ¯ Key Benefits

### âœ… **Backend-Generated IDs**
- No more hardcoded UUIDs in JSON files
- All IDs are generated by your backend automatically
- Proper database constraints and validation

### âœ… **Real User Workflows**
- Data is created through actual API endpoints
- Business logic validation happens automatically
- Relationships are maintained by the backend

### âœ… **No ID Dependencies**
- No need to maintain ID references across files
- No risk of foreign key constraint violations
- Automatic relationship resolution

### âœ… **Flexible Setup Scenarios**
- **Basic**: Minimal clinic setup for development
- **Full**: Complete clinic with sample data
- **Demo**: Full demo environment with all features

## ðŸš€ Quick Start

### Clear Environment
```bash
# Clear all data for a tenant (useful for testing)
npx tsx db/seeds/scripts/setup-via-api.ts --env http://localhost:3000 --tenant adris --type clear
```

### Basic Setup (Development)
```bash
# Setup basic clinic structure
npx tsx db/seeds/scripts/setup-via-api.ts --env http://localhost:3000 --tenant adris --type basic
```

### Full Setup (Testing)
```bash
# Setup complete clinic with sample data
npx tsx db/seeds/scripts/setup-via-api.ts --env http://localhost:3000 --tenant adris --type full
```

### Demo Setup (Showcase)
```bash
# Setup complete demo environment
npx tsx db/seeds/scripts/setup-via-api.ts --env http://localhost:3000 --tenant adris --type demo
```

### Reset Environment (Clear + Setup)
```bash
# Clear existing data and setup fresh demo environment
npx tsx db/seeds/scripts/setup-via-api.ts --clear-first --type demo
```

## ðŸ“‹ Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--env`, `--environment` | API base URL | `http://localhost:3000` |
| `--tenant` | Tenant ID to setup | `adris` |
| `--type` | Setup type: `basic`, `full`, `demo`, `clear` | `basic` |
| `--token` | Admin authentication token | Auto-login |
| `--no-skip` | Don't skip existing entities | Skip existing |
| `--clear-first` | Clear existing data before setup | `false` |

### Examples

```bash
# Production setup with custom token
npx tsx db/seeds/scripts/setup-via-api.ts \
  --env https://api.vetplatform.com \
  --tenant petlife \
  --type demo \
  --token eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...

# Development setup without skipping existing data
npx tsx db/seeds/scripts/setup-via-api.ts \
  --env http://localhost:3000 \
  --tenant adris \
  --type full \
  --no-skip
```

## ðŸ—ï¸ Setup Types Explained

### Basic Setup
Creates minimal clinic structure for development:
- âœ… Tenant configuration
- âœ… Clinic services
- âœ… Payment methods
- âœ… Kennels

### Full Setup
Complete clinic setup for testing:
- âœ… Everything in Basic
- âœ… QR tags
- âœ… Sample pet owners (5 profiles)
- âœ… Sample pets (15 pets across owners)
- âœ… Sample appointments (25 appointments)

### Demo Setup
Complete demo environment:
- âœ… Everything in Full
- âœ… Medical records (14 detailed records)
- âœ… Vaccine history (26 vaccine records)
- âœ… Active hospitalizations (4 cases)
- âœ… Store catalog (brands, categories, products)

### Clear Environment
Removes all data for testing/development:
- ðŸ—‘ï¸ Hospitalizations, vaccines, medical records
- ðŸ—‘ï¸ Appointments, pets, profiles
- ðŸ—‘ï¸ QR tags, kennels, payment methods, services
- ðŸ—‘ï¸ Resets ID tracker for clean slate

**Note:** Store catalog data (brands, categories, products) is preserved as it's typically shared across tenants.

## ðŸ”§ How It Works

### 1. ID Tracking System
The script automatically tracks created entity IDs:

```typescript
// When a profile is created
const created = await api.createProfile(profileData)
tracker.set('profile', 'original-id-from-json', created.id)
```

### 2. Automatic Reference Resolution
References are resolved automatically:

```typescript
// Original JSON has: "owner_id": "owner-001"
// API payload gets: "owner_id": "550e8400-e29b-41d4-a716-446655440001"
const resolvedData = tracker.resolveReferences(appointmentData, 'profile')
```

### 3. Dependency-Aware Creation Order
Entities are created in the correct order:
1. Tenants
2. Services, Payment Methods, Kennels (clinic setup)
3. Profiles (pet owners/vets)
4. Pets
5. Appointments, Medical Records, Vaccines (dependent data)
6. Hospitalizations, Store data (complex workflows)

## ðŸ“ Data Structure

The setup uses the same JSON data files but adapts them for API consumption:

```
data/
â”œâ”€â”€ 00-core/           # Tenants, demo accounts
â”œâ”€â”€ 01-reference/      # Global reference data
â”œâ”€â”€ 02-global/         # Pet owners, pets, medical history
â”œâ”€â”€ 02-clinic/         # Clinic-specific configuration
â”‚   â”œâ”€â”€ _global/       # Shared templates
â”‚   â”œâ”€â”€ adris/         # Clinic-specific data
â”‚   â””â”€â”€ petlife/       # Other clinics
â””â”€â”€ 03-store/          # E-commerce catalog
```

## ðŸ” Authentication

The script handles authentication automatically:

1. **Auto-login**: Attempts to login with `admin@demo.com` / `demo123`
2. **Custom token**: Use `--token` for production environments
3. **Tenant switching**: Automatically switches to specified tenant context

## ðŸ› ï¸ API Client Features

### Comprehensive Coverage
- All CRUD operations for main entities
- Proper error handling and logging
- Request/response logging for debugging
- Authentication and tenant context management

### Error Resilience
- Continues on individual entity failures
- Detailed error reporting
- Skip existing entities option

## ðŸ“Š Progress Tracking

The setup provides real-time progress:

```
ðŸš€ Starting environment setup via API
   Environment: http://localhost:3000
   Tenant: adris
   Setup Type: demo

ðŸ” Authenticating...
âœ… Authentication successful

ðŸ¢ Switching to tenant: adris
âœ… Tenant context set

ðŸ“‹ Running DEMO setup (complete demo environment)
ðŸ—ï¸  Setting up core data...
   âœ… Created tenant: Veterinaria Adris
ðŸ©º Setting up clinic services...
   âœ… Created service: Consulta General
   âœ… Created service: VacunaciÃ³n
...
```

## ðŸ› Troubleshooting

### Common Issues

#### Authentication Failed
```bash
# Check if your API is running and accessible
curl http://localhost:3000/health

# Use custom admin token
npx tsx setup-via-api.ts --token YOUR_ADMIN_TOKEN
```

#### Entity Creation Failed
```bash
# Check API logs for validation errors
# The script will continue with other entities
# Re-run with --no-skip to attempt failed entities again
```

#### Network Issues
```bash
# Verify API endpoint is correct
# Check firewall and network connectivity
# Use --env to specify different environment
```

### Debugging Mode

Add debugging by modifying the script:
```typescript
// Enable detailed logging
console.log('Request:', JSON.stringify(data, null, 2))
console.log('Response:', JSON.stringify(result, null, 2))
```

## ðŸ”„ Migration from SQL Approach

### What Changed
- **No more SQL generation** - Direct API calls instead
- **No hardcoded IDs** - Backend generates all IDs
- **Same data files** - JSON structure remains compatible
- **Better validation** - API validates all data

### What Stayed the Same
- **Data structure** - Same JSON files and organization
- **Entity relationships** - Same logical connections
- **Setup scenarios** - Basic, Full, Demo options

## ðŸ“ˆ Performance Considerations

### Batch Operations
- Entities are created sequentially to maintain dependencies
- Failed entities don't block others
- Progress logging for long-running setups

### Memory Usage
- JSON files are loaded as needed
- ID tracking uses efficient Map structures
- No large in-memory data structures

## ðŸš€ CI/CD Integration

### Automated Setup
```yaml
# In your deployment pipeline
- name: Setup demo environment
  run: |
    npx tsx db/seeds/scripts/setup-via-api.ts \
      --env ${{ secrets.API_URL }} \
      --tenant adris \
      --type demo \
      --token ${{ secrets.ADMIN_TOKEN }}
```

### Health Checks
```yaml
# Verify setup completed
- name: Verify setup
  run: |
    # Check that expected entities exist
    curl -H "Authorization: Bearer ${{ secrets.ADMIN_TOKEN }}" \
         ${{ secrets.API_URL }}/profiles | jq '.length >= 5'
```

## ðŸŽ¯ Best Practices

### Development
- Use `basic` setup for fast iteration
- Use `full` setup for feature testing
- Use `demo` setup for showcases

### Production
- Always use custom admin tokens
- Verify setup completion with API checks
- Monitor API logs during setup

### Testing
- Run setup before integration tests
- Use separate tenants for different test suites
- Clean up test data after test completion

### Environment Reset for Testing
```bash
# Quick reset for testing iterations
npm run env:reset:basic  # Clear + basic setup
npm run env:reset:full   # Clear + full setup
npm run env:reset        # Clear + demo setup (default)

# Manual reset with custom options
npx tsx db/seeds/scripts/setup-via-api.ts --type clear --tenant test-tenant
npx tsx db/seeds/scripts/setup-via-api.ts --clear-first --type full --tenant test-tenant
```

## ðŸ”® Future Enhancements

### Planned Features
- **Parallel creation** for better performance
- **Rollback capability** on setup failures
- **Incremental updates** for existing environments
- **Data validation** against API schemas
- **Setup profiles** for different clinic types

### Extension Points
- Add new entity types by extending `ApiClient`
- Create custom setup flows by extending `EnvironmentSetup`
- Add data transformations in the `resolveReferences` method

---

## ðŸ“ž Support

For issues with the API setup:
1. Check the troubleshooting section above
2. Review API logs for validation errors
3. Ensure your API endpoints match the expected interface
4. Verify tenant and authentication setup

The new API-based approach provides a more robust, maintainable way to set up your veterinary platform environments! ðŸŽ‰
